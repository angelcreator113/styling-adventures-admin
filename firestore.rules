rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ===== Helpers ===== */
    function isAuthed() { return request.auth != null; }
    function isAdmin() {
      return isAuthed() &&
        (request.auth.token.admin == true || request.auth.token.role == 'admin');
    }
    function isCreator() {
      return isAuthed() &&
        (request.auth.token.role == 'creator' || request.auth.token.role == 'admin');
    }
    function hasScope(s) {
      return isAdmin()
        && request.auth.token.adminScopes is map
        && request.auth.token.adminScopes[s] == true;
    }
    function can(scope) { return hasScope(scope); }

    function hasVisibility(d) {
      return d != null && (d.visibility == 'public' || d.visibility == 'private');
    }
    function creatingOwn() { return isAuthed() && request.resource.data.uid == request.auth.uid; }
    function isOwner()     { return isAuthed() && resource.data.uid == request.auth.uid; }

    function boardDocIsPublicRead() { return resource.data.visibility == 'public' || resource.data.public == true; }
    function boardDocIsOwnerRead()  { return isAuthed() && resource.data.uid == request.auth.uid; }
    function boardDocIsOwnerWrite() { return isAuthed() && request.resource.data.uid == request.auth.uid; }

    function validStatus(s) { return s == 'active' || s == 'archived' || s == null; }
    function pinUidToPath(uid)        { return request.resource.data.uid == uid; }
    function pinSpaceIdToPath(spaceId){ return request.resource.data.spaceId == spaceId; }
    function pinCatIdToPath(catId) {
      return (catId == null && (request.resource.data.catId == null || request.resource.data.catId == ''))
             || (catId != null && request.resource.data.catId == catId);
    }
    function pinFolderIdToPath(folderId) {
      return (folderId == null && (request.resource.data.folderId == null || request.resource.data.folderId == ''))
             || (folderId != null && request.resource.data.folderId == folderId);
    }
    function boardIsPublic(uid, boardId) {
      return get(/databases/$(database)/documents/users/$(uid)/boards/$(boardId)).data.visibility == 'public'
             || get(/databases/$(database)/documents/users/$(uid)/boards/$(boardId)).data.public == true;
    }

    /* Fan settings helper */
    function writesOwnFanSettings(uid) {
      return isAuthed()
        && request.auth.uid == uid
        && request.resource.data.themeId is string
        && request.resource.data.updatedAt == request.time;
    }

    /* ===== Users + PII ===== */
    match /users/{uid} {
      allow read, create, update, delete: if (isAuthed() && request.auth.uid == uid) || isAdmin();

      match /private/{docId} {
        allow read, update, delete: if (isAuthed() && request.auth.uid == uid) || isAdmin();
        allow create: if (isAuthed() && request.auth.uid == uid) || isAdmin();

        match /contact {
          allow create: if ((isAuthed() && request.auth.uid == uid) || isAdmin())
            && request.resource.data.keys().hasAll(['phone','address'])
            && request.resource.data.phone is string
            && request.resource.data.address is map
            && request.resource.data.address.keys().hasAll(['line1','city','region','postal','country'])
            && request.resource.data.address.line1 is string
            && request.resource.data.address.city  is string
            && request.resource.data.address.region is string
            && request.resource.data.address.postal is string
            && request.resource.data.address.country is string;
          allow read, update, delete: if (isAuthed() && request.auth.uid == uid) || isAdmin();
        }
      }

      match /settings/{docId} {
        allow read, create, update, delete: if isAuthed() && request.auth.uid == uid;
      }
    }

    /* ===== Admin registries ===== */
    match /panel_defs/{id} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    /* ===== Shared categories ===== */
    match /categories/{panel}/items/{docId} {
      allow read: if true;
      allow create, update, delete: if isAuthed();
    }

    /* ===== Legacy flat content ===== */
    match /closet/{docId} {
      allow read: if (hasVisibility(resource.data) && resource.data.visibility == 'public') || isOwner() || isAdmin();
      allow create: if (creatingOwn() || isAdmin()) && hasVisibility(request.resource.data);
      allow update: if (isOwner() || isAdmin()) && hasVisibility(request.resource.data);
      allow delete: if isOwner() || isAdmin();
    }

    match /voice/{docId} {
      allow read: if true;
      allow create: if isCreator() && creatingOwn() && hasVisibility(request.resource.data);
      allow update, delete: if (isCreator() && isOwner()) || isAdmin();
    }

    match /episodes/{docId} {
      allow read: if true;
      allow create: if isCreator() && creatingOwn() && hasVisibility(request.resource.data);
      allow update, delete: if (isCreator() && isOwner()) || isAdmin();
    }

    /* ===== Per-user closet ===== */
    match /users/{uid}/closet/{docId} {
      allow read: if (hasVisibility(resource.data) && resource.data.visibility == 'public')
                  || (isAuthed() && request.auth.uid == uid)
                  || isAdmin();
      allow create: if hasVisibility(request.resource.data)
                    && request.resource.data.uid == uid
                    && ((isAuthed() && request.auth.uid == uid) || isAdmin());
      allow update: if hasVisibility(request.resource.data)
                    && request.resource.data.uid == uid
                    && ((isAuthed() && request.auth.uid == uid) || isAdmin());
      allow delete: if (isAuthed() && request.auth.uid == uid) || isAdmin();
    }

    /* ===== Toolbox categories ===== */
    match /users/{uid}/categories/{catId} {
      allow read, create, update, delete: if isAuthed() && request.auth.uid == uid;
    }

    /* ===== Planner ===== */
    match /users/{uid}/planner/events/{eventId} {
      allow read, create, update, delete: if isAuthed() && request.auth.uid == uid;
    }

    /* ===== Public home content ===== */
    match /public/{docId}/items/{id} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    /* ===== Theme library + per-day votes ===== */
    match /themes/{themeId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();

      match /votes/{voteId} {
        allow create: if isAuthed()
          && request.resource.data.uid == request.auth.uid
          && request.resource.data.themeId == themeId
          && request.resource.data.createdAt == request.time
          && !exists(/databases/$(database)/documents/themes/$(themeId)/votes/$(voteId));
        allow read: if isAuthed() && resource.data.uid == request.auth.uid;
        allow update, delete: if false;
      }
    }

    match /public/themes/{themeId} {
      allow read: if true;
      allow create, update, delete: if isAdmin() || can("themes.curate");
    }

    /* ===== Bestie Chat ===== */
    match /threads/{id} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    match /threads/{id}/replies/{rid} {
      allow read: if true;
      allow create: if isAuthed()
                    && get(/databases/$(database)/documents/threads/$(id)).data.locked != true;
      allow update, delete: if isAdmin()
                             || can("comments.moderate")
                             || (isAuthed() && request.auth.uid == resource.data.uid);
    }
    match /threads/{id}/reactions/{uidType} {
      allow read: if true;
      allow create, delete: if isAuthed()
        && uidType.matches('^' + request.auth.uid + '(_.*)?$')
        && get(/databases/$(database)/documents/threads/$(id)).data.locked != true;
      allow update: if false;
    }

    /* ===== Boards ===== */
    match /users/{uid}/boards/{boardId} {
      allow read: if (isAuthed() && request.auth.uid == uid)
                  || boardIsPublic(uid, boardId)
                  || isAdmin();
      allow create, update: if (isAuthed() && request.auth.uid == uid) || can("content.write");
      allow delete: if (isAuthed() && request.auth.uid == uid) || can("content.delete");

      match /items/{itemId} {
        allow read: if (isAuthed() && request.auth.uid == uid)
                    || boardIsPublic(uid, boardId)
                    || isAdmin();
        allow create, update: if (isAuthed() && request.auth.uid == uid) || can("content.write");
        allow delete: if (isAuthed() && request.auth.uid == uid) || can("content.delete");
      }
    }
    match /{anyPath=**}/boards/{boardId} {
      allow read: if boardDocIsPublicRead() || boardDocIsOwnerRead() || isAdmin();
      allow create, update: if boardDocIsOwnerWrite() || can("content.write");
      allow delete: if boardDocIsOwnerWrite() || can("content.delete");
    }

    /* ===== Metrics ===== */
    match /users/{uid}/metrics/{coll}/{docId=**} {
      allow read, create, update, delete: if (isAuthed() && request.auth.uid == uid) || isAdmin();
    }
    match /admin/metrics/{docId=**} {
      allow read, write: if isAdmin() || can("admin.metrics");
    }

    /* ===== Creator Spaces + Files ===== */
    match /users/{uid}/spaces/{spaceId} {
      allow read: if (isAuthed() && request.auth.uid == uid) || isAdmin();
      allow create: if (isAuthed() && request.auth.uid == uid && pinUidToPath(uid)) || isAdmin();
      allow update: if ((isAuthed() && request.auth.uid == uid && pinUidToPath(uid)) || isAdmin());
      allow delete: if (isAuthed() && request.auth.uid == uid) || isAdmin();

      match /items/{itemId} {
        allow read: if (isAuthed() && request.auth.uid == uid) || isAdmin();
        allow create: if (isAuthed() && request.auth.uid == uid)
                      && pinUidToPath(uid)
                      && pinSpaceIdToPath(spaceId)
                      && pinCatIdToPath(null)
                      && pinFolderIdToPath(null)
                      && validStatus(request.resource.data.status);
        allow update: if (isAuthed() && request.auth.uid == uid)
                      && request.resource.data.uid == uid
                      && request.resource.data.spaceId == spaceId
                      && validStatus(request.resource.data.status)
                      || isAdmin();
        allow delete: if (isAuthed() && request.auth.uid == uid) || isAdmin();
      }
      match /categories/{catId} {
        allow read, create, update, delete: if (isAuthed() && request.auth.uid == uid) || isAdmin();

        match /items/{itemId} {
          allow read: if (isAuthed() && request.auth.uid == uid) || isAdmin();
          allow create: if (isAuthed() && request.auth.uid == uid)
                        && pinUidToPath(uid)
                        && pinSpaceIdToPath(spaceId)
                        && pinCatIdToPath(catId)
                        && pinFolderIdToPath(null)
                        && validStatus(request.resource.data.status);
          allow update: if (isAuthed() && request.auth.uid == uid)
                        && request.resource.data.uid == uid
                        && request.resource.data.spaceId == spaceId
                        && request.resource.data.catId == catId
                        && validStatus(request.resource.data.status)
                        || isAdmin();
          allow delete: if (isAuthed() && request.auth.uid == uid) || isAdmin();
        }

        match /folders/{folderId} {
          allow read, create, update, delete: if (isAuthed() && request.auth.uid == uid) || isAdmin();

          match /items/{itemId} {
            allow read: if (isAuthed() && request.auth.uid == uid) || isAdmin();
            allow create: if (isAuthed() && request.auth.uid == uid)
                          && pinUidToPath(uid)
                          && pinSpaceIdToPath(spaceId)
                          && pinCatIdToPath(catId)
                          && pinFolderIdToPath(folderId)
                          && validStatus(request.resource.data.status);
            allow update: if (isAuthed() && request.auth.uid == uid)
                          && request.resource.data.uid == uid
                          && request.resource.data.spaceId == spaceId
                          && request.resource.data.catId == catId
                          && request.resource.data.folderId == folderId
                          && validStatus(request.resource.data.status)
                          || isAdmin();
            allow delete: if (isAuthed() && request.auth.uid == uid) || isAdmin();
          }
        }
      }
    }

    /* collectionGroup reads of .../items across Space paths — owner/admin */
    match /{path=**}/items/{anyItem} {
      allow read: if (isAuthed() && resource.data.uid == request.auth.uid) || isAdmin();
    }

    /* Creator Files (legacy) */
    match /users/{uid}/files/{categoryId} {
      allow read, create, update, delete: if (isAuthed() && request.auth.uid == uid) || isAdmin();
      match /folders/{folderId} {
        allow read, create, update, delete: if (isAuthed() && request.auth.uid == uid) || isAdmin();
        match /items/{itemId} {
          allow read, create, update, delete: if (isAuthed() && request.auth.uid == uid) || isAdmin();
        }
      }
    }

    /* Admin Content Files (global) */
    match /contentFiles/{categoryId} {
      allow read, create, update, delete: if isAdmin();
      match /folders/{folderId} {
        allow read, create, update, delete: if isAdmin();
        match /items/{itemId} {
          allow read, create, update, delete: if isAdmin();
        }
      }
    }

    /* Saved creator panels */
    match /users/{uid}/panels/{panelId} {
      allow read, create, update, delete: if isAuthed() && request.auth.uid == uid;
    }

    /* ===== Fan theme selection ===== */
    match /fanSettings/{uid} {
      allow read: if isAuthed() && request.auth.uid == uid;
      allow create, update: if writesOwnFanSettings(uid);
      allow delete: if isAuthed() && request.auth.uid == uid;
    }

    /* ===== Theme Campaigns (VIP gate supported) ===== */
    match /themeCampaigns/{cid} {
      allow read: if true;               // make lists visible to fans
      allow create, update, delete: if isAdmin();

      match /votes/{voteId} {
        function campaignActive(c) {
          return c.status == 'active'
            && (c.startAt == null || c.startAt <= request.time)
            && (c.endAt == null || request.time <= c.endAt);
        }
        function isVip(uid) {
          return (request.auth.token.vip == true)
            || (get(/databases/$(database)/documents/users/$(uid)/settings/profile).data.tier == 'vip')
            || (get(/databases/$(database)/documents/users/$(uid)/settings/profile).data.vipActive == true);
        }
        allow read: if true;
        allow create: if isAuthed()
          && get(/databases/$(database)/documents/themeCampaigns/$(cid)).data is map
          && campaignActive(get(/databases/$(database)/documents/themeCampaigns/$(cid)).data)
          && request.resource.data.uid == request.auth.uid
          && request.resource.data.createdAt == request.time
          && !exists(/databases/$(database)/documents/themeCampaigns/$(cid)/votes/$(voteId))
          && (request.resource.data.themeId in (get(/databases/$(database)/documents/themeCampaigns/$(cid)).data.themeIds))
          && (
            get(/databases/$(database)/documents/themeCampaigns/$(cid)).data.vipOnly != true
            || isVip(request.auth.uid)
          );
        allow update, delete: if false;
      }
    }

    /* ===== Admin Access Requests (fans can create, admins review) ===== */
    match /adminAccessRequests/{rid} {
      // fan creates a request about themselves
      allow create: if isAuthed()
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.createdAt == request.time;

      // only admins may read/update/delete
      allow read, update, delete: if isAdmin();
    }

    /* ===== Admin PIN internals (function-only; deny all client access) ===== */
    match /adminPins/{uid} { allow read, write: if false; }
    match /adminPinUniq/{id} { allow read, write: if false; }
    match /adminPinAudit/{docId} { allow read, write: if false; }
    match /adminPinFails/{uid} { allow read, write: if false; }

    /* ===== Fallback ===== */
    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}
