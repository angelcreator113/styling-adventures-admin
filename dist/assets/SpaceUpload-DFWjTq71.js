import{r as i,j as t,c as P,b as j,e as Q,s as R,h as X,d as Y,P as Z}from"./index-Dpurs1Jy.js";import{p as I}from"./image-pipeline-NuN-Pp6Y.js";import{u as ee}from"./firebase-helpers-C5EXP52w.js";import"./index.esm-Cclw387c.js";import"./theme-service-yZ4BYXBV.js";function re({spaceName:D="Space",uid:n,spaceId:o,cats:W=[],folders:_=[],catId:a="",setCatId:F=()=>{},folderId:u="",setFolderId:C=()=>{},addCategory:$,addFolder:L,compact:H=!1}){const T=i.useRef(null),A=i.useRef(null),f=i.useRef(null),[g,w]=i.useState(""),[m,E]=i.useState(""),[k,v]=i.useState(!1),[p,b]=i.useState(0),[N,B]=i.useState(!1),[x,S]=i.useState(""),[d,M]=i.useState("image");i.useEffect(()=>{const e=A.current;if(!e)return;const s=c=>{c.preventDefault(),e.classList.add("is-hover")},l=()=>e.classList.remove("is-hover"),r=c=>{c.preventDefault(),e.classList.remove("is-hover");const h=c.dataTransfer.files?.[0];h&&z(h)};return e.addEventListener("dragover",s),e.addEventListener("dragleave",l),e.addEventListener("drop",r),()=>{e.removeEventListener("dragover",s),e.removeEventListener("dragleave",l),e.removeEventListener("drop",r)}},[]);const O=i.useMemo(()=>d==="video"?"video/*":d==="audio"?"audio/*":"image/*",[d]);function V(){T.current?.click()}function q(e){const s=e.target.files?.[0];e.target.value="",s&&z(s)}async function z(e){try{if(v(!0),b(0),B(!1),E(e.name||"file"),d==="image"){const s=await I(e,{smartCompress:!0,trimBg:!1,padToSquare:!0,preferServer:!0,exportPreview:!0,exportIcon:!0,exportIconHover:!0});f.current={kind:"image",uploadBlob:s.cutoutBlob,previewBlob:s.previewBlob,iconBlob:s.iconBlob,iconHoverBlob:s.iconHoverBlob};const l=s.previewUrl||(s.previewBlob?URL.createObjectURL(s.previewBlob):"");S(l)}else f.current={kind:d,uploadBlob:e},S(URL.createObjectURL(e));if(B(!0),!g){const s=(e.name||"").replace(/\.[^.]+$/,"");w(s||`File ${new Date().toLocaleString()}`)}}catch(s){console.warn("[spaces] process failed",s),alert("Couldn’t process that file.")}finally{v(!1)}}function U(){f.current=null,w(""),E(""),S(""),B(!1),b(0)}async function G(){if(!n||!o)return alert("Please sign in.");const e=f.current;if(!e?.uploadBlob)return alert("Choose a file first.");try{v(!0),b(1);const s=`images/users/${n}/spaces/${o}`,l=e.kind==="image",r=await ee(e.uploadBlob,{slug:"spaces",pathPrefix:s,public:!1,uiPrefix:"space-up",onProgress:J=>b(Math.round(J||0)),metadata:{uid:n,spaceId:o,catId:a||"",folderId:u||"",title:g||"Item",visibility:"private",mediaType:e.kind,contentType:(l?"image/png":e.uploadBlob.type)||"application/octet-stream",cacheControl:"public,max-age=31536000"},extraUploads:l?[{key:"preview",blob:e.previewBlob,contentType:"image/jpeg"},{key:"icon",blob:e.iconBlob,contentType:"image/png"},{key:"iconHover",blob:e.iconHoverBlob,contentType:"image/png"}]:[]}),c=r?.downloadURL||r?.url||r?.assets?.file?.url||"",h=l?r?.assets?.preview?.url||"":c;let y;a&&u?y=P(j,`users/${n}/spaces/${o}/categories/${a}/folders/${u}/items`):a?y=P(j,`users/${n}/spaces/${o}/categories/${a}/items`):y=P(j,`users/${n}/spaces/${o}/items`),await Q(y,{uid:n,spaceId:o,catId:a||null,folderId:u||null,title:g||null,fileName:r?.fileName||m||null,fileUrl:c||null,previewUrl:h||null,storagePath:r?.fullPath||null,contentType:(l?"image/png":e.uploadBlob.type)||null,mediaType:e.kind||"image",status:"active",createdAt:R(),updatedAt:R()});try{await X(Y(j,`users/${n}/spaces/${o}`),{fileCount:Z(1),updatedAt:R(),lastPreviewUrl:h||c||null})}catch{}U()}catch(s){console.warn("[spaces] upload failed",s),alert(`Upload failed for ${m||"file"}. See console.`)}finally{v(!1)}}const K=i.useMemo(()=>N&&!k&&p===0,[N,k,p]);return t.jsxs("div",{className:"dashboard-card",style:{padding:12},children:[t.jsxs("h3",{style:{margin:"4px 0 10px"},children:["Upload to “",D,"”"]}),t.jsxs("div",{style:{display:"flex",gap:10,alignItems:"center",marginBottom:8},children:[t.jsx("span",{className:"muted",style:{fontSize:12},children:"File type"}),t.jsx("div",{className:"seg",style:{display:"flex",gap:6},children:[{key:"image",label:"Photo"},{key:"video",label:"Video"},{key:"audio",label:"Audio"}].map(e=>t.jsx("button",{type:"button",className:`pill ${d===e.key?"is-active":""}`,onClick:()=>{M(e.key),U()},children:e.label},e.key))})]}),t.jsxs("div",{style:{display:"grid",gridTemplateColumns:H?"1fr 180px":"1fr 220px",gap:12,alignItems:"start",marginBottom:8,minWidth:0},children:[t.jsxs("div",{ref:A,onClick:V,style:{border:"2px dashed #e5d9ff",background:"#f8f5ff",height:170,borderRadius:14,display:"grid",placeItems:"center",cursor:"pointer",minWidth:0},title:"Click to choose a file",children:[t.jsx("input",{ref:T,type:"file",accept:O,hidden:!0,onChange:q}),t.jsx("div",{style:{color:"#7c3aed",fontWeight:600,textAlign:"center"},children:"Drag & drop or click to choose a file…"})]}),t.jsx("div",{className:"dashboard-card",style:{padding:8,height:170,borderRadius:12,minWidth:0},children:x?d==="video"?t.jsx("video",{src:x,style:{width:"100%",height:"100%",objectFit:"contain",borderRadius:10,border:"1px solid #eee"},controls:!0,muted:!0}):d==="audio"?t.jsx("div",{style:{display:"grid",placeItems:"center",height:"100%"},children:t.jsx("audio",{src:x,controls:!0,style:{width:"100%"}})}):t.jsx("div",{style:{width:"100%",height:"100%",borderRadius:10,border:"1px solid #eee",background:`#fff url("${x}") center/contain no-repeat`},"aria-label":"Preview"}):t.jsx("div",{className:"muted",style:{fontSize:13},children:"Pick a file to preview it here."})})]}),m&&t.jsxs("div",{className:"dashboard-card",style:{padding:8,display:"flex",alignItems:"center",gap:10,marginBottom:10},children:[t.jsx("div",{style:{width:28,height:28,borderRadius:8,background:"#eee",display:"grid",placeItems:"center",fontSize:12},title:"Selected file",children:"📄"}),t.jsxs("div",{style:{flex:1,minWidth:0},children:[t.jsx("div",{style:{fontSize:13,overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"},title:m,children:m}),t.jsxs("div",{style:{marginTop:6},children:[t.jsx("div",{style:{height:6,background:"#eee",borderRadius:6},children:t.jsx("div",{style:{height:6,width:`${p||0}%`,borderRadius:6,background:p>0?"#7c3aed":"#d1fae5",transition:"width 200ms linear"}})}),t.jsx("div",{className:"muted",style:{fontSize:12,marginTop:4},children:p>0?`${p}% uploading…`:N?"✅ Ready to upload":"Processing…"})]})]}),t.jsx("button",{className:"btn sm",onClick:U,disabled:k,children:"Clear"})]}),t.jsx("div",{className:"muted",style:{fontSize:12,margin:"6px 0"},children:"Step 2 — Pick where it goes (optional)"}),t.jsxs("label",{className:"input",style:{marginBottom:8},children:[t.jsx("div",{className:"input__label",children:"Category"}),t.jsxs("div",{style:{display:"flex",gap:8},children:[t.jsxs("select",{className:"select",value:a,onChange:e=>{F(e.target.value),C("")},style:{flex:1},children:[t.jsx("option",{value:"",children:"— none —"}),W.map(e=>t.jsx("option",{value:e.id,children:e.title||e.id},e.id))]}),t.jsx("button",{className:"btn sm",type:"button",onClick:async()=>{const e=prompt("New category name?");e&&$&&await $(e.trim())},children:"New"})]})]}),t.jsxs("label",{className:"input",style:{marginBottom:8},children:[t.jsx("div",{className:"input__label",children:"Subfolder"}),t.jsxs("div",{style:{display:"flex",gap:8},children:[t.jsxs("select",{className:"select",value:u,onChange:e=>C(e.target.value),style:{flex:1},disabled:!a,children:[t.jsx("option",{value:"",children:"— none —"}),_.map(e=>t.jsx("option",{value:e.id,children:e.title||e.id},e.id))]}),t.jsx("button",{className:"btn sm",type:"button",disabled:!a,onClick:async()=>{const e=prompt("New subfolder name?");e&&L&&await L(a,e.trim())},children:"New"})]})]}),t.jsx("div",{className:"muted",style:{fontSize:12,margin:"6px 0"},children:"Step 3 — Add a title (optional)"}),t.jsx("label",{className:"input",style:{marginBottom:10},children:t.jsx("input",{className:"input__field",placeholder:"Give it a name…",value:g,onChange:e=>w(e.target.value)})}),t.jsxs("details",{style:{marginBottom:8},children:[t.jsx("summary",{className:"muted",children:"Advanced"}),t.jsxs("div",{className:"muted",style:{fontSize:12,marginTop:6},children:["• Spaces uploads are ",t.jsx("strong",{children:"private"})," by default.",t.jsx("br",{}),"• Background remover is ",t.jsx("strong",{children:"off"})," for Spaces.",t.jsx("br",{}),"• Files are stored under ",t.jsx("code",{children:"images/users/<uid>/spaces/<spaceId>"}),".",t.jsx("br",{}),"• Video/Audio are uploaded without image processing."]})]}),t.jsxs("div",{style:{display:"flex",gap:10},children:[t.jsx("button",{className:"btn primary",onClick:G,disabled:!K,children:p>0?"Uploading…":"Upload to Space"}),t.jsx("button",{className:"btn",disabled:!0,children:"Use Camera"})]})]})}export{re as default};
