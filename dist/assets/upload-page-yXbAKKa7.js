import{c as Z,b as _,m as F,f as G,q as J,x as re,a as ae,l as se,i as ie,d as X,g as ce}from"./index-Dpurs1Jy.js";import{u as le}from"./firebase-helpers-C5EXP52w.js";import{p as ue}from"./image-pipeline-NuN-Pp6Y.js";import{a as de}from"./board-helpers-BSw2y6wO.js";const fe="categories",P=e=>`dropdowns-${e}`,ee=new Map,O=new Map,K={closet:{Tops:{Tees:["Graphic","Plain"],Blouses:["Silk","Cotton"]},Bottoms:{Jeans:["Straight","Skinny"],Skirts:["Mini","Midi"]}},voice:{Narration:{Promo:["Short","Long"],Tutorial:["Step-by-step"]},Dialogue:{Interview:["Guest"],Monologue:["Personal"]}},episodes:{Season1:{Ep01:["Cut A","Cut B"],Ep02:["Cut A"]},Clips:{Shorts:["15s","30s"],Trailers:["Teaser"]}}},j=e=>e!==null&&typeof e=="object"&&!Array.isArray(e),x=e=>e&&typeof e=="object"&&!Array.isArray(e)&&Object.keys(e).length>0;async function pe(e){const t=await me(e),n=te(t),r=be(n);return ee.set(e,{tree:n,map:r}),ve(e),M(e)}function M(e){const t=ee.get(e)||{tree:{},map:{}};return{categories:t.tree,map:t.map}}function ye(e,t){let n=O.get(e);n||(n=new Set,O.set(e,n)),n.add(t);try{t(M(e))}catch(r){console.error(r)}return()=>O.get(e)?.delete(t)}async function me(e){const t=e==="episode"?"episodes":e;try{const n=Z(_,`${fe}/${t}/items`),r=await F(n),s={};r.forEach(p=>{s[p.id]=p.data()||{}});const i=x(s)?s:null,a=W(P(t)),o=x(a)?a:null,c=K[t]||{},y=i||o||c;return ge(P(t),y),y}catch(n){console.warn(`[CategoryStore] Firestore load failed for '${t}', using local fallback.`,n);const r=W(P(t));return x(r)?r:K[t]||{}}}function W(e){try{const t=localStorage.getItem(e);return t?JSON.parse(t):null}catch{return null}}function ge(e,t){try{localStorage.setItem(e,JSON.stringify(t))}catch{}}function te(e){if(!j(e))return e;const t={};for(const[n,r]of Object.entries(e||{}))n!=="isDeleted"&&(j(r)&&r.isDeleted||(t[n]=te(r)));return t}function be(e){const t={},n=(r,s=[])=>{if(j(r))for(const[i,a]of Object.entries(r)){if(i==="isDeleted")continue;const o=[...s,i];t[o.join("/")]=a,j(a)&&n(a,o)}};return n(e),t}function ve(e){const t=M(e);(O.get(e)||new Set).forEach(n=>{try{n(t)}catch(r){console.error("[CategoryStore] subscriber error",r)}})}function he(e=""){return/^[A-Za-z0-9_-]{20,}$/.test(String(e))}function I(e){return e&&typeof e=="object"&&!Array.isArray(e)}const we=new Set(["id","uid","slug","key","value","name","label","title","displayName","text","createdAt","updatedAt","order"]);function R(e,t=""){return typeof e=="string"?e:I(e)?e.name||e.label||e.title||e.displayName||e.text||e.data?.name||e.data?.label||t||"":t||""}function C(e,{childrenOnly:t=!1}={}){if(!e)return[];if(typeof e=="string")return[];if(Array.isArray(e))return e.map(n=>typeof n=="string"?n:R(n)).filter(Boolean);if(I(e)){const n=[];for(const[r,s]of Object.entries(e)){if(we.has(r)||t&&!(Array.isArray(s)||I(s))||he(r))continue;const i=R(s,r);i&&n.push(String(i))}return[...new Set(n)]}return[]}function D(e,t,n){const r=C(e,{childrenOnly:!0});let s=[],i=[];const a=t&&e?e[t]??Object.values(e).find(o=>R(o)===t):null;if(a){if(Array.isArray(a))i=C(a);else if(I(a)){s=C(a,{childrenOnly:!0});const o=n&&a?a[n]??Object.values(a).find(c=>R(c)===n):null;o&&(Array.isArray(o)?i=C(o):I(o)?i=C(o,{childrenOnly:!1}):i=[])}}return{categories:r,subcats:s,items:i}}function $(e,t){if(!e)return;const n=e.value;e.innerHTML='<option value="">Select</option>';const r=new Set;for(const s of t){if(!s||r.has(s))continue;r.add(s);const i=document.createElement("option");i.value=s,i.textContent=s,e.appendChild(i)}n&&t.includes(n)&&(e.value=n)}function Se(e,t,n,r,s={}){const{skipActiveCheck:i=!1,initialValue:a}=s;if(!r)return console.warn("[SmartDropdown] Missing panelType identifier. Setup skipped."),z();if(!i&&!document.querySelector(`#${r}, #${r}-panel, [data-panel="${r}"]`))return z();let o={category:"",subcategory:"",subsubcategory:""};const c=()=>M(r)?.categories||{},y=()=>{o.category=e?.value||"";const u=c(),{subcats:b}=D(u,o.category,"");$(t,b),o.subcategory="",$(n,[]),o.subsubcategory=""},p=()=>{o.subcategory=t?.value||"";const u=c(),{items:b}=D(u,o.category,o.subcategory);$(n,b),o.subsubcategory=""},v=()=>{o.subsubcategory=n?.value||""};e?.addEventListener("change",y),t?.addEventListener("change",p),n?.addEventListener("change",v);let m=()=>{};const w=()=>{m=ye(r,()=>{const u=c(),{categories:b,subcats:S,items:T}=D(u,o.category,o.subcategory);$(e,b),o.category&&!b.includes(o.category)&&(o.category=""),e&&(e.value=o.category),$(t,S),o.subcategory&&!S.includes(o.subcategory)&&(o.subcategory=""),t&&(t.value=o.subcategory),$(n,T),o.subsubcategory&&!T.includes(o.subsubcategory)&&(o.subsubcategory=""),n&&(n.value=o.subsubcategory)})};return(async()=>{try{await pe(r)}catch(S){console.warn("[SmartDropdown] loadCategories failed:",S)}const u=c(),{categories:b}=D(u,"","");$(e,b),a?.category&&e&&(e.value=a.category),y(),a?.subcategory&&t&&(t.value=a.subcategory),p(),a?.subsubcategory&&n&&(n.value=a.subsubcategory),v(),w()})(),{getValue:()=>({...o}),setValue:u=>{u.category&&e&&(e.value=u.category,y()),u.subcategory&&t&&(t.value=u.subcategory,p()),u.subsubcategory&&n&&(n.value=u.subsubcategory,v())},destroy:()=>{e?.removeEventListener("change",y),t?.removeEventListener("change",p),n?.removeEventListener("change",v);try{m()}catch{}}}}function z(){return{getValue:()=>({category:"",subcategory:"",subsubcategory:""}),setValue:()=>{},destroy:()=>{}}}function De({panelId:e,panelTypeOverride:t,skipActiveCheck:n=!0}){const r=e.replace(/-panel$/,""),s=document.getElementById(e)||document.getElementById(r)||document.querySelector(`[data-panel="${r}"]`);if(!s)return;const i=p=>s.querySelector(`#${r}-${p}`),a=i("category"),o=i("subcategory"),c=i("subsubcategory");if(!a||!o)return;Se(a,o,c,t||r,{skipActiveCheck:n})}const h=e=>document.getElementById(e),$e=e=>e?.replace?.(/\s+/g,"-")||"item";function Q(e){const t=(a,o)=>{const c=document.getElementById(a);return typeof c?.checked=="boolean"?c.checked:o},n=(a,o)=>{const c=document.getElementById(a);return c&&"value"in c?c.value:o},r=t(`${e}feat-public`,null),s=t(`${e}is-public`,null),i=r??s??!0;return{smartCompress:t(`${e}feat-compress`,!0),trimBg:t(`${e}feat-trim`,!0),padToSquare:t(`${e}feat-pad`,!0),autoName:t(`${e}feat-autoname`,!0),makePublic:i,preferServer:t(`${e}feat-server`,!0),theme:n(`${e}appearance-theme`,"lavender"),exportPreview:t(`${e}export-preview`,!0),exportIcon:t(`${e}export-icon`,!0),exportIconHover:t(`${e}export-icon-hover`,!0),dest:n(`${e}dest`,"closet")}}async function Le(e,t=20){const n=await e.arrayBuffer(),r=await crypto.subtle.digest("SHA-256",n),s=new Uint8Array(r);let i="";for(let a=0;a<s.length;a++)i+=s[a].toString(16).padStart(2,"0");return i.slice(0,t)}async function ke({uid:e,keepId:t,storagePath:n,fileName:r}){try{const s=Z(_,`users/${e}/closet`),i=J(s,re("storagePath","==",n)),a=await F(i),o=J(s,ae("uploadedAt","desc"),se(20)),c=await F(o),y=new Set;a.forEach(m=>{m.id!==t&&y.add(m.id)});const p=Math.floor(Date.now()/1e3);c.forEach(m=>{if(m.id===t)return;const w=m.data()||{},u=w.uploadedAt?.seconds||0,b=p-u;b>=0&&b<=120&&(w.fileName||"")===(r||"")&&y.add(m.id)});const v=Array.from(y).map(m=>ie(X(_,`users/${e}/closet/${m}`)).catch(()=>{}));await Promise.all(v)}catch{}}async function Ae(e,t){try{const n=await ce(X(_,`users/${e.uid}/settings/brand`));return n.exists()&&n.data().themeId||""||t.theme||"lavender"}catch{return t.theme||"lavender"}}function Ce(e,t){const n=`__bestieUploadInit__${t}`;if(typeof window<"u"&&window[n])return window[n];const r=h(`${t}file-input`),s=h(`${t}drop-area`),i=h(`${t}file-list`),a=h(`${t}progress`),o=h(`${t}progress-label`),c=h(`${t}upload-btn`);let y=null,p=null,v=null,m=null,w=!1;function u(d,f,l="normal"){a&&(a.hidden=!1,a.value=d,a.dataset.mode=l,o&&(o.textContent=f||`${Math.round(d)}%`),d>=100&&l!=="ready"&&setTimeout(()=>{a.hidden=!0,o&&(o.textContent=""),a.dataset.mode="normal"},400))}function b(){u(100,"Ready to Upload","ready"),a?.classList.add("is-ready")}function S(){a?.classList.remove("is-ready"),a?.removeAttribute("data-mode")}function T(d,f="Ready to Upload"){if(!i)return;i.dataset.empty="false",i.innerHTML="";const l=document.createElement("div");l.className="file-card",l.innerHTML=`
      <div class="file-thumb"></div>
      <div class="file-meta"><div class="file-title"></div></div>
    `;const g=l.querySelector(".file-thumb");g.style.backgroundImage=`url("${d}")`,g.style.backgroundPosition="center",g.style.backgroundRepeat="no-repeat",g.style.backgroundSize="contain",g.style.width="100%",g.style.aspectRatio="3 / 4",g.style.border="1px solid #eee",g.style.borderRadius="12px",g.style.backgroundColor="#fff",g.style.padding="10px",l.querySelector(".file-title").textContent=f,i.append(l),m=d}function ne(){if(i){i.innerHTML="",i.dataset.empty="true";try{m&&m.startsWith("blob:")&&URL.revokeObjectURL(m)}catch{}m=null}}async function B(d){if(!d)return;const f=G.currentUser;if(!f){alert("Please sign in");return}S(),u(0,"Processing…");const l=Q(t),g=await Ae(f,l),{cutoutBlob:L,previewBlob:N,previewUrl:H,iconBlob:q,iconHoverBlob:U}=await ue(d,{smartCompress:l.smartCompress,trimBg:l.trimBg,padToSquare:l.padToSquare,previewTheme:g,preferServer:l.preferServer,exportPreview:l.exportPreview,exportIcon:l.exportIcon,exportIconHover:l.exportIconHover}),k=await Le(L,20);v=`${f.uid}-${k}`,T(H||URL.createObjectURL(L),"Ready to Upload"),y=L,p={previewBlob:N,iconBlob:q,iconHoverBlob:U},b()}async function V(d){if(d?.preventDefault?.(),!!c&&!(w||c.getAttribute("data-busy")==="1")){w=!0,c.setAttribute("data-busy","1"),c.disabled=!0,S();try{if(!y){alert("Please choose an image first");return}const f=G.currentUser;if(!f){alert("Please sign in");return}const l=Q(t),g=h(`${t}title`),L=h(`${t}category`)?.value||"",N=h(`${t}subcategory`)?.value||"",H=h(`${t}subsubcategory`)?.value||"",q=g?.value?.trim()||(l.autoName?$e(`Closet Item ${Date.now()}`):""),U=`${f.uid}-${Date.now()}-${Math.random().toString(36).slice(2,8)}`;window.__bestie_intentToken=U;const k=[];l.exportPreview&&p?.previewBlob&&k.push({key:"preview",blob:p.previewBlob,contentType:"image/jpeg"}),l.exportIcon&&p?.iconBlob&&k.push({key:"icon",blob:p.iconBlob,contentType:"image/png"}),l.exportIconHover&&p?.iconHoverBlob&&k.push({key:"iconHover",blob:p.iconHoverBlob,contentType:"image/png"}),u(2,"Uploading…");const A=await le(y,{slug:e,public:l.makePublic,uiPrefix:t,onProgress:E=>u(E,E>=99?"Finishing…":void 0),metadata:{uid:f.uid,visibility:l.makePublic?"public":"private",public:!!l.makePublic,title:q,category:L,subcategory:N,subsubcategory:H,confirmedByUser:!0,intentToken:U,clientUploadId:v,features:l,contentType:"image/png",cacheControl:"public,max-age=31536000"},extraUploads:k});if(A?.cancelled){u(0,"Cancelled");return}const oe=A?.assets?.preview?.url||"";await de({uid:f.uid,itemId:A?.docId,category:L,previewUrl:oe}),await ke({uid:f.uid,keepId:A?.docId,storagePath:A?.fullPath,fileName:A?.fileName}),y=null,v=null,p=null,ne(),u(100,"Uploaded")}catch(f){console.warn("[upload] failed",f),alert("Upload failed. See console.")}finally{c.removeAttribute("data-busy"),c.disabled=!1,w=!1,setTimeout(()=>{try{delete window.__bestie_intentToken}catch{}},1500)}}}if(c){const d=`__bestieUploadClick__${t}`;window[d]&&c.removeEventListener("click",window[d]),window[d]=V,c.addEventListener("click",V)}r?.addEventListener("change",async d=>{const f=d.target.files?.[0];f&&await B(f),r.value=""}),s?.addEventListener("dragover",d=>{d.preventDefault(),s.classList.add("is-hover")}),s?.addEventListener("dragleave",()=>s.classList.remove("is-hover")),s?.addEventListener("drop",async d=>{d.preventDefault(),s.classList.remove("is-hover");const f=d.dataTransfer.files?.[0];f&&await B(f)}),document.addEventListener("bestie:manualProcess",async d=>{const{blob:f,uiPrefix:l}=d.detail||{};f&&(l&&l!==t||await B(f))},{passive:!0});const Y={ingest:B};return typeof window<"u"&&(window[n]=Y),Y}const Oe=Ce;export{Ce as a,De as i,Oe as u};
