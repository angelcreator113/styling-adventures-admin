import{S as I,f as q}from"./index-Dpurs1Jy.js";import{h as H,g as j}from"./index.esm-Cclw387c.js";import{g as O,B as Y}from"./theme-service-yZ4BYXBV.js";function X(t){return new Promise((a,e)=>{const o=new FileReader;o.onload=()=>a(String(o.result).split(",")[1]||""),o.onerror=e,o.readAsDataURL(t)})}function k(t,a="image/png"){const e=atob(t),o=e.length,n=new Uint8Array(o);for(let r=0;r<o;r++)n[r]=e.charCodeAt(r);return new Blob([n],{type:a})}async function x(t){const a=H(j(I,"us-central1"),"removeBgPro"),e=await X(t),n=(await a({imageBase64:e}))?.data?.imageBase64;if(!n)throw new Error("removeBgPro returned no image");return k(n,"image/png")}async function D(t){const a=await t.arrayBuffer(),e=new Uint8Array(a),o=URL.createObjectURL(new Blob([e],{type:t.type||"image/png"})),n=await createImageBitmap(await fetch(o).then(r=>r.blob()));return URL.revokeObjectURL(o),n}function v(t,a){const e=document.createElement("canvas");return e.width=t,e.height=a,e}function F(t){const a=v(t.width,t.height),e=a.getContext("2d");e.drawImage(t,0,0);const{data:o,width:n,height:r}=e.getImageData(0,0,a.width,a.height);let i=n,u=r,d=-1,f=-1,g=0,m=0,c=0;const s=8;for(let l=0;l<r;l++){let b=l*n*4;for(let w=0;w<n;w++){const y=o[b+w*4+3];y>s&&(w<i&&(i=w),l<u&&(u=l),w>d&&(d=w),l>f&&(f=l),g+=y*w,m+=y*l,c+=y)}}if(d<0||f<0)return i=0,u=0,d=n-1,f=r-1,{minX:i,minY:u,maxX:d,maxY:f,cx:n/2,cy:r/2,width:n,height:r};const h=c>0?g/c:(i+d)/2,p=c>0?m/c:(u+f)/2;return{minX:i,minY:u,maxX:d,maxY:f,cx:h,cy:p,width:n,height:r}}function Q(t){return t*Math.PI/180}function L(t,a,e,o){const n=o.radius??20,r=o.shadow??10;t.save(),t.shadowColor="rgba(0,0,0,.10)",t.shadowBlur=r,t.shadowOffsetY=Math.max(2,Math.round(r/3));const i=n;if(t.beginPath(),t.moveTo(i,0),t.lineTo(a-i,0),t.quadraticCurveTo(a,0,a,i),t.lineTo(a,e-i),t.quadraticCurveTo(a,e,a-i,e),t.lineTo(i,e),t.quadraticCurveTo(0,e,0,e-i),t.lineTo(0,i),t.quadraticCurveTo(0,0,i,0),t.closePath(),t.fillStyle="#fff",t.fill(),t.shadowColor="transparent",t.clip(),o.type==="solid")t.fillStyle=o.colors&&o.colors[0]||"#ffffff",t.fillRect(0,0,a,e);else{const u=Q(o.angle??90),d=a/2,f=e/2,g=Math.cos(u),m=Math.sin(u),c=Math.max(a,e)*.75,s=t.createLinearGradient(d-g*c,f-m*c,d+g*c,f+m*c),h=o.colors?.length?o.colors:["#fafafa","#f1f1f1"];if(h.length===1)s.addColorStop(0,h[0]),s.addColorStop(1,h[0]);else{const p=h.length;h.forEach((l,b)=>s.addColorStop(b/(p-1),l))}t.fillStyle=s,t.fillRect(0,0,a,e)}t.restore()}function T(t,a,e,o,n,r){const i=Math.max(0,Math.min(.45,r.marginPct??.1)),u=r.biasY??0,d=e.maxX-e.minX+1,f=e.maxY-e.minY+1,g=o*(1-i*2),m=n*(1-i*2),c=Math.min(g/d,m/f),s=o/2,h=n/2+n*u,p=s-e.cx*c,l=h-e.cy*c;t.imageSmoothingQuality="high",t.drawImage(a,0,0,a.width,a.height,p,l,a.width*c,a.height*c)}async function M(t,a="image/png",e){return new Promise(o=>t.toBlob(n=>o(n),a,e))}async function _(t,{smartCompress:a=!0,trimBg:e=!0,padToSquare:o=!0,previewTheme:n="Lavender",preferServer:r=!0,exportPreview:i=!0,exportIcon:u=!0,exportIconHover:d=!0}={}){let f=t;if(r)try{f=await x(t)}catch(S){console.warn("[pipeline] server removeBg failed; using original image",S)}const g=await D(f),m=F(g),c=q.currentUser?.uid||null;let s=Y[n]||Y.Lavender;try{c&&(s=await O(c,n))}catch{}let h=null,p="";if(i){const B=v(1024,1024),C=B.getContext("2d");L(C,1024,1024,s),T(C,g,m,1024,1024,s),h=await M(B,"image/jpeg",.92),p=URL.createObjectURL(h)}const l=Math.max(g.width,g.height),b=v(l,l),w=b.getContext("2d");T(w,g,m,l,l,{marginPct:0,biasY:0});const y=await M(b,"image/png");let P=null,R=null;if(u||d){const B=v(256,256),C=B.getContext("2d");if(L(C,256,256,{...s,shadow:Math.min(6,s.shadow||8),radius:Math.min(12,s.radius||16)}),T(C,g,m,256,256,s),u&&(P=await M(B,"image/png")),d){const A=v(256,256),U=A.getContext("2d");L(U,256,256,{...s,shadow:(s.shadow||10)+6}),U.filter="saturate(1.06)",T(U,g,m,256,256,s),R=await M(A,"image/png")}}return{cutoutBlob:y,previewBlob:h,previewUrl:p,iconBlob:P,iconHoverBlob:R}}export{_ as p};
