import{r as l,f as E,z as le,d as O,o as P,b,q as I,a as F,c as T,e as K,s as k,x as U,a6 as ie,h as q,y as ce,P as oe,j as e,u as de,a0 as ue}from"./index-Dpurs1Jy.js";import{u as fe}from"./firebase-helpers-C5EXP52w.js";import me from"./SpaceUpload-DFWjTq71.js";import"./image-pipeline-NuN-Pp6Y.js";import"./index.esm-Cclw387c.js";import"./theme-service-yZ4BYXBV.js";function pe(){const[t,a]=l.useState(E.currentUser?.uid||null),[c,i]=l.useState(!E.currentUser);return l.useEffect(()=>le(E,r=>{a(r?.uid||null),i(!1)}),[]),{uid:t,loading:c}}function he(t,a){const[c,i]=l.useState(null),[o,r]=l.useState(!!t&&!!a),[s,u]=l.useState(!1),[f,d]=l.useState(null);return l.useEffect(()=>{if(!t||!a){i(null),u(!1),r(!1);return}r(!0);const h=O(b,`users/${t}/spaces/${a}`);return P(h,x=>{if(r(!1),!x.exists()){u(!0),i(null);return}u(!1),i({id:x.id,...x.data()})},x=>{r(!1),d(x)})},[t,a]),{space:c,loading:o,missing:s,error:f}}function ge(t,a,c){const[i,o]=l.useState([]),[r,s]=l.useState([]);l.useEffect(()=>{if(!t||!a){o([]);return}const d=I(T(b,`users/${t}/spaces/${a}/categories`),F("createdAt","asc"));return P(d,h=>o(h.docs.map(p=>({id:p.id,...p.data()}))))},[t,a]),l.useEffect(()=>{if(!t||!a||!c){s([]);return}const d=I(T(b,`users/${t}/spaces/${a}/categories/${c}/folders`),F("createdAt","asc"));return P(d,h=>s(h.docs.map(p=>({id:p.id,...p.data()}))))},[t,a,c]);async function u(d){if(!(!t||!a||!d))return K(T(b,`users/${t}/spaces/${a}/categories`),{title:d.trim(),createdAt:k()})}async function f(d,h){const p=d||c;if(!(!t||!a||!p||!h))return K(T(b,`users/${t}/spaces/${a}/categories/${p}/folders`),{title:h.trim(),createdAt:k()})}return{cats:i,folders:r,addCategory:u,addFolder:f}}function ve({uid:t,spaceId:a,catId:c,folderId:i,status:o="active",qText:r=""}){const[s,u]=l.useState([]),[f,d]=l.useState(!1),[h,p]=l.useState(null);l.useEffect(()=>{if(!t||!a){u([]),d(!1);return}d(!1),p(null);const g=[U("uid","==",t),U("spaceId","==",a)];c&&g.push(U("catId","==",c)),i&&g.push(U("folderId","==",i)),o!=="all"&&g.push(U("status","==",o));const w=I(ie(b,"items"),...g,F("createdAt","desc"));return P(w,S=>{u(S.docs.map(y=>({id:y.id,ref:y.ref,...y.data()})))},S=>{p(S),S?.code==="failed-precondition"&&d(!0)})},[t,a,c,i,o]);const x=l.useMemo(()=>{const g=(r||"").trim().toLowerCase();return g?s.filter(w=>(w.title||"").toLowerCase().includes(g)||(w.fileName||"").toLowerCase().includes(g)):s},[s,r]);return{items:x,rawItems:s,count:x.length,indexPending:f,error:h}}function xe(t,a){return async function(i){if(!t||!a||!i)return;const o=await fe(i,{slug:"spaces",public:!1,uiPrefix:"space-cover",metadata:{uid:t,spaceId:a,variant:"cover",contentType:i.type||"image/jpeg",cacheControl:"public,max-age=31536000"}}),r=o?.assets?.file?.url||o?.downloadURL||o?.url||o?.assets?.preview?.url||"";return await q(O(b,`users/${t}/spaces/${a}`),{coverUrl:r||null,updatedAt:k(),lastPreviewUrl:r||null}),r}}function be(t,a){async function c(r){if(!r?.ref)return;const s=(r.title||r.fileName||"Item").toString(),u=prompt("Rename item",s);if(!(!u||u.trim()===s))try{await q(r.ref,{title:u.trim(),updatedAt:k()})}catch(f){console.warn("[spaces] rename failed",f),alert("Rename failed.")}}async function i(r){if(!r?.ref)return;const s=(r.status||"active")==="active"?"archived":"active";try{await q(r.ref,{status:s,updatedAt:k()})}catch(u){console.warn("[spaces] archive toggle failed",u),alert("Couldn’t update status.")}}async function o(r){if(!(!r?.ref||!t||!a)&&confirm("Delete this item?"))try{const s=ce(b);s.delete(r.ref),s.update(O(b,`users/${t}/spaces/${a}`),{fileCount:oe(-1),updatedAt:k()}),await s.commit()}catch(s){console.warn("[spaces] delete failed",s),alert("Delete failed.")}}return{renameItem:c,toggleArchive:i,deleteItem:o}}function je({space:t,status:a="active",onStatusChange:c,onSearchChange:i,onAllSpaces:o,onPickCover:r}){const s=l.useRef(null),u=t?.coverUrl||t?.lastPreviewUrl||"/images/placeholder-cover.png";return e.jsxs("header",{children:[e.jsxs("div",{style:{position:"relative",width:"100%",aspectRatio:"21 / 9",borderRadius:16,overflow:"hidden",background:`#f6f6ff url("${u}") center/cover no-repeat`,border:"1px solid #eee"},children:[e.jsx("div",{style:{position:"absolute",inset:0,background:"linear-gradient(to top, rgba(0,0,0,.35), rgba(0,0,0,.05))"}}),e.jsxs("div",{style:{position:"absolute",top:12,left:12,display:"flex",gap:8},children:[e.jsx("input",{ref:s,type:"file",accept:"image/*",hidden:!0,onChange:f=>{const d=f.target.files?.[0];f.target.value="",d&&r?.(d)}}),e.jsx("button",{className:"btn sm",onClick:()=>s.current?.click(),children:"Change cover"})]}),e.jsxs("div",{style:{position:"absolute",left:16,bottom:12,right:16},children:[e.jsx("div",{className:"muted",style:{color:"white",opacity:.9,fontSize:12,marginBottom:4},children:"Space"}),e.jsx("h1",{className:"page-title",style:{color:"white",margin:0,textShadow:"0 1px 6px rgba(0,0,0,.35)"},children:t?.name||"—"})]})]}),e.jsxs("div",{className:"dashboard-card",style:{marginTop:10,display:"grid",gridTemplateColumns:"220px 1fr auto",gap:10,alignItems:"center"},children:[e.jsxs("select",{className:"select",value:a,onChange:f=>c?.(f.target.value),children:[e.jsx("option",{value:"active",children:"Active"}),e.jsx("option",{value:"archived",children:"Archived"}),e.jsx("option",{value:"all",children:"All"})]}),e.jsx("input",{className:"input__field",placeholder:"Search title or file…",onChange:f=>i?.(f.target.value)}),e.jsx("button",{className:"btn",onClick:o,children:"All Spaces"})]})]})}function Se({items:t=[],onArchive:a,onDelete:c,onRename:i,selectedIds:o=new Set,onToggleSelect:r=()=>{}}){return e.jsx("div",{className:"space-grid",style:{display:"grid",gap:12,gridTemplateColumns:"repeat(auto-fill, minmax(200px, 1fr))",alignItems:"start"},children:t.map(s=>{const u=(s.status||"active")!=="active",f=o.has(s.id),d=we(s);return e.jsxs("article",{className:`space-card ${f?"is-selected":""}`,style:{padding:8,borderRadius:12,border:"1px solid #eee",background:"#fff",boxShadow:"0 1px 2px rgba(0,0,0,0.04)",position:"relative"},children:[e.jsx("label",{style:{position:"absolute",top:8,left:8,background:"#fff",borderRadius:8,padding:4,boxShadow:"0 1px 2px rgba(0,0,0,0.1)",display:"grid",placeItems:"center"},title:f?"Unselect":"Select",children:e.jsx("input",{type:"checkbox",checked:!!f,onChange:()=>r(s.id)})}),e.jsx("div",{style:{width:"100%",aspectRatio:"3 / 4",borderRadius:10,border:"1px solid #eee",overflow:"hidden",background:"#fafafa",display:"grid",placeItems:"center"},children:d==="video"?e.jsx("video",{src:s.previewUrl||s.fileUrl,style:{width:"100%",height:"100%",objectFit:"cover"},muted:!0,controls:!0}):d==="audio"?e.jsx("div",{style:{padding:12,width:"100%"},children:e.jsx("audio",{src:s.fileUrl,controls:!0,style:{width:"100%"}})}):e.jsx("div",{style:{width:"100%",height:"100%",background:`#fff url("${s.previewUrl||s.fileUrl||""}") center/cover no-repeat`}})}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:8,gap:8},children:[e.jsxs("div",{style:{fontWeight:600,fontSize:14,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},title:s.title||"Item",children:[s.title||"Item",u&&e.jsx("span",{className:"muted",style:{fontSize:12,marginLeft:6},children:"(archived)"})]}),e.jsxs("div",{style:{display:"flex",gap:6,flexWrap:"wrap"},children:[e.jsx("button",{className:"btn sm",onClick:()=>i(s),children:"Rename"}),e.jsx("button",{className:"btn sm",onClick:()=>a(s),children:u?"Restore":"Archive"}),e.jsx("button",{className:"btn sm danger",onClick:()=>c(s),children:"Delete"})]})]})]},s.id)})})}function we(t){const a=(t.contentType||"").toLowerCase();if(a.startsWith("video/"))return"video";if(a.startsWith("audio/"))return"audio";const c=t.fileUrl||t.previewUrl||"";return/\.(mp4|webm|mov)$/i.test(c)?"video":/\.(mp3|wav|m4a|aac|ogg)$/i.test(c)?"audio":"image"}function ye({state:t="idle",label:a=""}){const c=t==="building"?"#f59e0b":t==="ok"?"#10b981":"#cbd5e1";return e.jsx("span",{title:a,"aria-label":a,style:{display:"inline-block",width:10,height:10,borderRadius:"50%",backgroundColor:c,boxShadow:"0 0 0 2px #fff",verticalAlign:"middle"}})}function Ce({aside:t,children:a}){return e.jsxs("div",{className:"space-layout",children:[e.jsx("aside",{className:"space-left",children:t}),e.jsx("main",{className:"space-right",children:a})]})}const Ne=["all","active","archived"],Ae=[{value:"new",label:"Newest"},{value:"old",label:"Oldest"},{value:"az",label:"A–Z"},{value:"za",label:"Z–A"}];function ze(){const{spaceId:t,id:a}=de(),c=ue(),i=t||a,{uid:o,loading:r}=pe(),{space:s,loading:u,missing:f}=he(o,i),[d,h]=l.useState("active"),[p,x]=l.useState(""),[g,w]=l.useState(""),[S,y]=l.useState(""),[$,V]=l.useState("new"),{cats:Z,folders:H,addCategory:Q,addFolder:J}=ge(o,i,g),{items:M,count:X,indexPending:W}=ve({uid:o,spaceId:i,catId:g,folderId:S,status:d,qText:p}),Y=xe(o,i),{toggleArchive:B,deleteItem:_,renameItem:ee}=be(o,i),z=l.useRef(null),R=r||u,j=l.useMemo(()=>[...M].sort((n,m)=>{const v=n.createdAt?.seconds||0,A=m.createdAt?.seconds||0;return $==="az"?(n.title||"").localeCompare(m.title||""):$==="za"?(m.title||"").localeCompare(n.title||""):$==="old"?v-A:A-v}),[M,$]),[C,D]=l.useState(new Set),N=C.size,te=l.useCallback(n=>{D(m=>{const v=new Set(m);return v.has(n)?v.delete(n):v.add(n),v})},[]),L=l.useCallback(()=>D(new Set),[]),se=l.useCallback(()=>D(new Set(j.map(n=>n.id))),[j]),G=async(n="archived")=>{const m=new Map(j.map(v=>[v.id,v]));await Promise.all(Array.from(C).map(v=>{const A=m.get(v);if(!A)return Promise.resolve();const re=n==="archived",ne=(A.status||"active")!=="active";return re!==ne?B(A):Promise.resolve()})),L()},ae=async()=>{if(!C.size||!confirm(`Delete ${C.size} item(s)?`))return;const n=new Map(j.map(m=>[m.id,m]));await Promise.all(Array.from(C).map(m=>_(n.get(m)))),L()};return l.useEffect(()=>{!r&&!u&&(f||i&&!s)&&c("/creator/spaces",{replace:!0})},[r,u,f,s,i,c]),l.useEffect(()=>{!R&&j.length===0&&z.current&&z.current.scrollIntoView({behavior:"smooth",block:"start"})},[R,j.length]),e.jsxs("section",{className:"container space-detail",style:{padding:16},children:[R&&e.jsx("div",{children:"Loading…"}),!R&&s&&e.jsxs(e.Fragment,{children:[e.jsx(je,{space:s,status:d,onStatusChange:h,onSearchChange:x,onAllSpaces:()=>c("/creator/spaces"),onPickCover:n=>Y(n).catch(()=>alert("Could not update the cover image.")),rightAccessory:W&&e.jsx(ye,{title:"Building index…"})}),e.jsx(Ce,{aside:e.jsx("div",{ref:z,children:e.jsx(me,{compact:!0,spaceName:s.name||"Space",uid:o,spaceId:i,cats:Z,folders:H,catId:g,setCatId:n=>{w(n),y("")},folderId:S,setFolderId:y,addCategory:Q,addFolder:J})}),children:e.jsxs("div",{className:"dashboard-card",style:{padding:12},children:[e.jsxs("div",{className:"space-toolbar",children:[e.jsx("div",{className:"pill-row",children:Ne.map(n=>e.jsx("button",{className:`pill ${d===n?"is-active":""}`,onClick:()=>h(n),children:n.charAt(0).toUpperCase()+n.slice(1)},n))}),e.jsx("div",{className:"muted count-label",children:N>0?`${N} selected`:`${X} item(s)`}),e.jsx("div",{}),e.jsxs("label",{className:"sort-label",children:[e.jsx("span",{className:"muted",children:"Sort"}),e.jsx("select",{className:"select",value:$,onChange:n=>V(n.target.value),children:Ae.map(n=>e.jsx("option",{value:n.value,children:n.label},n.value))})]}),e.jsxs("div",{className:"bulk-actions",children:[e.jsx("button",{className:"btn sm",onClick:se,children:"Select all"}),e.jsx("button",{className:"btn sm",onClick:L,disabled:!N,children:"Clear"}),e.jsx("button",{className:"btn sm",onClick:()=>G("archived"),disabled:!N,children:"Archive"}),e.jsx("button",{className:"btn sm",onClick:()=>G("active"),disabled:!N,children:"Restore"}),e.jsx("button",{className:"btn sm danger",onClick:ae,disabled:!N,children:"Delete"})]})]}),W&&e.jsxs("div",{className:"dashboard-card index-warning",children:[e.jsx("div",{style:{fontWeight:600},children:"Building search index…"}),e.jsx("div",{className:"muted",style:{fontSize:13},children:"Firestore is creating the index. Items will appear soon."})]}),j.length===0?e.jsx("div",{className:"dashboard-card empty-space",children:"No items yet in this Space. Use the panel on the left to upload."}):e.jsx(Se,{items:j.slice(0,10),onArchive:B,onDelete:_,onRename:async n=>{const m=prompt("New title?",n.title||"");m!=null&&await ee(n,m.trim())},selectedIds:C,onToggleSelect:te})]})})]})]})}export{ze as default};
