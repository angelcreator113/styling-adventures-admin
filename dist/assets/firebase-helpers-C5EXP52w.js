import{f as D,d as F,b as E,w as R,e as S,c as q,n as U,p as j,B as z,v as A,s as I}from"./index-Dpurs1Jy.js";function v(t,s,o){o&&document.dispatchEvent(new CustomEvent(t,{detail:s}))}function T(t){return String(t||"").replace(/^\/*/,"").replace(/\/*$/,"")}function L(t,s){const o=s?.contentType||t?.type||"image/png",i=(()=>{const f=o.indexOf("/");if(f===-1)return"png";const p=o.slice(f+1).toLowerCase();return p.includes("jpeg")?"jpg":p||"png"})(),n=t&&typeof t.name=="string"&&t.name.trim()||`upload.${i}`,l=/\.[a-z0-9]+$/i.test(n),d=n.replace(/[^\S\r\n]+/g,"-").replace(/[\/\\]+/g,"-").replace(/[\u0000-\u001f]+/g,"").slice(0,180);return l?d:`${d}.${i}`}function P({file:t,path:s,uiPrefix:o,metadata:i={},onProgress:n,emitDomEvents:l=!1}){if(!t)throw new Error("uploadFile: 'file' is required");if(!s)throw new Error("uploadFile: 'path' is required");const d=T(s);return new Promise((f,p)=>{const u=L(t,i),m=`${d}/${Date.now()}-${u}`,$=U(j,m),a=z($,t,i);a.on("state_changed",e=>{const h=Math.max(0,Math.min(100,e.bytesTransferred/e.totalBytes*100||0));n?.(h,e.bytesTransferred,e.totalBytes),v("upload:progress",{uiPrefix:o,progress:h,bytesTransferred:e.bytesTransferred,totalBytes:e.totalBytes,fileName:u,path:m},l)},e=>{v("upload:error",{uiPrefix:o,error:String(e),fileName:u,path:m},l),p(e)},async()=>{const e=await A(a.snapshot.ref);v("upload:complete",{uiPrefix:o,url:e,fileName:u,path:m},l),f({url:e,fullPath:m,bytes:a.snapshot.totalBytes,contentType:i?.contentType||t?.type||"application/octet-stream",fileName:u})})})}async function W(t,{slug:s,public:o=!0,onProgress:i,uiPrefix:n,metadata:l={},extraUploads:d,pathPrefix:f,storageFolder:p,derivedSubfolder:u="derived",writeToFirestore:m=!1,collectionPath:$}){const a=D.currentUser;if(!a)throw new Error("Not signed in");const e={...o?{cacheControl:"public,max-age=31536000"}:{},...l};let h=T(f||(p?`images/users/${a.uid}/${p}`:s==="closet"?`images/users/${a.uid}/closet`:s==="voice"?`images/users/${a.uid}/voice`:s==="spaces"?(()=>{const r=e.spaceId;if(!r)throw new Error("uploadFileWithProgress('spaces'): metadata.spaceId is required when pathPrefix is not provided");return`images/users/${a.uid}/spaces/${r}`})():`images/users/${a.uid}/episodes`));const c=await P({file:t,path:h,uiPrefix:n,onProgress:i,metadata:e,emitDomEvents:!1});let y={};if(d?.length){const r=`${h}/${T(u)}`;for(const g of d){if(!g?.blob||!g?.key)continue;const b=await P({file:g.blob,path:r,uiPrefix:n,metadata:{contentType:g.contentType||"application/octet-stream",cacheControl:"public,max-age=31536000"},emitDomEvents:!1});y[g.key]={url:b.url,path:b.fullPath,contentType:b.contentType,bytes:b.bytes,fileName:b.fileName}}}if(!m)return{...c,assets:y};const B=$||(s==="closet"?`users/${a.uid}/closet`:s==="voice"?"voice":s==="spaces"?`users/${a.uid}/spaces/${e.spaceId||"default"}/items`:"episodes"),k=document.getElementById(`${n}feat-public`)?.checked??document.getElementById(`${n}is-public`)?.checked??!0?"public":"private",C=e.title||document.getElementById(`${n}title`)?.value?.trim()||"",N={uid:a.uid,slug:s,visibility:k,path:c.fullPath,storagePath:c.fullPath,url:c.url,fileName:c.fileName,contentType:c.contentType,bytes:c.bytes,title:C,assets:y,source:"manual",uploadedAt:I(),updatedAt:I()},w=e.clientUploadId;if(w){const r=F(E,B,w);return await R(r,N,{merge:!0}),{...c,docRef:r,docId:w,assets:y}}else{const r=await S(q(E,B),N);return{...c,docRef:r,docId:r.id,assets:y}}}export{W as u};
