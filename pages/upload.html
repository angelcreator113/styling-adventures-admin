<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Upload Manager</title>

  <!-- Styles -->
  <link rel="stylesheet" href="../css/styles.css" />
  <link rel="stylesheet" href="../css/upload-closet.css" />
  <link rel="stylesheet" href="../css/upload-voice.css" />
  <link rel="stylesheet" href="../css/upload-episode.css" />
  <link rel="stylesheet" href="../css/meta-panel.css" />
  <link rel="stylesheet" href="../css/smart-dropdown.css" />
  <link rel="stylesheet" href="../css/manage-categories.css" />

  <style>
    body { background-color: #fdf7ff; margin: 0; font-family: "Segoe UI", sans-serif; }
    .topbar { display: flex; align-items: center; padding: 1rem 2rem; background: linear-gradient(to right, #f4d9ff, #e6c4ff); }
    .topbar h1 { margin-left: 0.5rem; color: #39104a; font-size: 1.5rem; }
    .tab-buttons { display: flex; gap: 1rem; padding: 1rem 2rem; flex-wrap: wrap; }
    .tab-button { background-color: #e9c9ff; border: none; border-radius: 12px; padding: 0.75rem 1.5rem; font-weight: bold; font-size: 1rem; color: #39104a; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: background-color 0.3s; }
    .tab-button:hover, .tab-button.active { background-color: #d1a4ff; }
    #panel-wrapper { padding: 2rem; }
    .panel { display: none; }
    .panel.active { display: block; }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="topbar">
    <img src="../assets/lala-avatar.png" alt="Icon" width="32" height="32" />
    <h1>Upload Manager</h1>
  </header>

  <!-- Tab Buttons -->
  <div class="tab-buttons">
    <button class="tab-button active" data-panel="closet-panel">üßµ Closet</button>
    <button class="tab-button" data-panel="voice-panel">üé§ Voice</button>
    <button class="tab-button" data-panel="episodes-panel">üé¨ Episodes</button>
    <button class="tab-button" data-panel="meta-panel">üß† Meta</button>
    <button class="tab-button" data-panel="manage-panels-panel">üõ†Ô∏è Upload Manager</button>
  </div>

  <!-- Panel Container -->
  <main id="panel-wrapper">
    <!-- Panels loaded dynamically -->
  </main>

  <!-- Panel Loader + Closet/Voice/Episode UI Init -->
  <script type="module">
    const wrapper = document.getElementById("panel-wrapper");

    const panels = [
      { id: "closet-panel", path: "../partials/closet-panel.html" },
      { id: "voice-panel", path: "../partials/voice-panel.html" },
      { id: "episodes-panel", path: "../partials/episodes-panel.html" },
      { id: "meta-panel", path: "../partials/meta-panel.html" },
      { id: "manage-panels-panel", path: "../partials/manage-panels-panel.html" }
    ];

    // üîí one-time init guards
    const initGuards = {
      closet: false,
      voice: false,
      episodes: false,
    };

    // Helper: try a list of function names exported by a module
    function tryInit(mod, fnNames = []) {
      for (const name of fnNames) {
        if (typeof mod[name] === 'function') {
          queueMicrotask(() => mod[name]());
          return true;
        }
      }
      return false;
    }

    async function loadPanel(panel) {
      try {
        const res = await fetch(panel.path);
        const html = await res.text();
        const container = document.createElement("div");
        container.innerHTML = html.trim();
        const el = container.firstElementChild;
        if (!el) return;
        el.id = panel.id;
        el.classList.add("panel");
        if (panel.id === "closet-panel") el.classList.add("active");
        wrapper.appendChild(el);

        // ‚úÖ Initialize corresponding UI AFTER the panel has been injected
        if (panel.id === 'closet-panel' && !initGuards.closet) {
          try {
            const mod = await import('../js/uploads/closet/closet-upload.js');
            if (tryInit(mod, ['setupClosetUploadUI', 'initClosetUpload', 'setupUploadUI'])) {
              initGuards.closet = true;
            }
          } catch (err) { console.error('Closet UI init failed:', err); }
        }
        if (panel.id === 'voice-panel' && !initGuards.voice) {
          try {
            const mod = await import('../js/uploads/voice/index.js');
            if (tryInit(mod, ['setupVoiceUploadUI', 'initVoiceUpload', 'setupUploadUI'])) {
              initGuards.voice = true;
            }
          } catch (err) { console.error('Voice UI init failed:', err); }
        }
        if (panel.id === 'episodes-panel' && !initGuards.episodes) {
          try {
            const mod = await import('../js/uploads/episodes/index.js');
            if (tryInit(mod, ['setupEpisodeUploadUI', 'initEpisodeUpload', 'setupUploadUI'])) {
              initGuards.episodes = true;
            }
          } catch (err) { console.error('Episodes UI init failed:', err); }
        }
      } catch (err) {
        console.error(`Failed to load ${panel.id}:`, err);
      }
    }

    // Load all panels
    panels.forEach(loadPanel);

    // Tab switching + lazy safety init on first activation
    document.addEventListener("click", async e => {
      const btn = e.target.closest(".tab-button");
      if (!btn) return;
      const targetId = btn.dataset.panel;

      document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      document.querySelectorAll(".panel").forEach(p => p.classList.toggle("active", p.id === targetId));

      // On-demand init if panel was loaded before guards flipped
      try {
        if (targetId === 'voice-panel' && !initGuards.voice && document.getElementById('voice-panel')) {
          const mod = await import('../js/uploads/voice/index.js');
          if (tryInit(mod, ['setupVoiceUploadUI', 'initVoiceUpload', 'setupUploadUI'])) initGuards.voice = true;
        }
        if (targetId === 'episodes-panel' && !initGuards.episodes && document.getElementById('episodes-panel')) {
          const mod = await import('../js/uploads/episodes/index.js');
          if (tryInit(mod, ['setupEpisodeUploadUI', 'initEpisodeUpload', 'setupUploadUI'])) initGuards.episodes = true;
        }
        if (targetId === 'closet-panel' && !initGuards.closet && document.getElementById('closet-panel')) {
          const mod = await import('../js/uploads/closet/closet-upload.js');
          if (tryInit(mod, ['setupClosetUploadUI', 'initClosetUpload', 'setupUploadUI'])) initGuards.closet = true;
        }
      } catch (lazyErr) {
        console.error('Lazy init error:', lazyErr);
      }
    });
  </script>
</body>
</html>
