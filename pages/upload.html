<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Upload Manager</title>

  <!-- Topbar + site styles -->
  <link rel="stylesheet" href="/css/topbar.css" />
  <link rel="stylesheet" href="/css/styles.css" />

  <!-- Panel styles -->
  <link rel="stylesheet" href="/css/upload-closet.css" />
  <link rel="stylesheet" href="/css/upload-voice.css" />
  <link rel="stylesheet" href="/css/upload-episode.css" />
  <link rel="stylesheet" href="/css/meta-panel.css" />
  <link rel="stylesheet" href="/css/smart-dropdown.css" />
  <link rel="stylesheet" href="/css/manage-categories.css" />
  <style>
    /* Utility moved from inline â†’ CSS to satisfy no-inline-styles */
    .grid-span-full { grid-column: 1 / -1; }
  </style>
</head>
<body>
  <!-- Reusable topbar container (mountTopbar injects the .topbar-inner markup) -->
  <div id="app-topbar"></div>

  <!-- Page grid -->
  <div class="page">
    <!-- Panels inject here -->
    <main id="panel-wrapper" class="panel-card grid-span-full"></main>
  </div>

  <!-- Toasts -->
  <div id="toasts" class="toast-area" aria-live="polite"></div>

  <!-- Firebase first -->
  <script type="module" src="/js/firebase-config.js"></script>
  <script type="module" src="/js/utils/firebase-client.js"></script>

  <!-- Mount the topbar (new markup with .topbar-inner comes from /js/ui/topbar.js) -->
  <script type="module">
    import { mountTopbar } from '/js/ui/topbar.js';
    mountTopbar('#app-topbar');
  </script>

  <!-- Loader + smart-jump target -->
  <script type="module">
    import { ready } from '/js/utils/firebase-client.js';
    await ready();

    const wrapper = document.getElementById('panel-wrapper');

    // Panels to load
    const panels = [
      { id: 'closet-panel',   path: '/partials/closet-panel.html' },
      { id: 'voice-panel',    path: '/partials/voice-panel.html' },
      { id: 'episodes-panel', path: '/partials/episodes-panel.html' },
      { id: 'meta-panel',     path: '/partials/meta-panel.html' },
      { id: 'manage-panels-panel', path: '/partials/manage-panels-panel.html' }
    ];

    // Prevent double-init
    const initGuards = { closet: false, voice: false, episodes: false };

    function tryInit(mod, fnNames = []) {
      for (const name of fnNames) {
        if (typeof mod[name] === 'function') {
          setTimeout(() => mod[name](), 0);
          return true;
        }
      }
      return false;
    }

    async function loadPanel(panel) {
      try {
        const res = await fetch(panel.path);
        const html = await res.text();

        const container = document.createElement('div');
        container.innerHTML = html.trim();

        const el = container.firstElementChild;
        if (!el) return;

        el.id = panel.id;
        el.classList.add('panel');
        if (panel.id === 'closet-panel') el.classList.add('active');

        wrapper.appendChild(el);

        // Lazy init per panel (first-touch)
        if (panel.id === 'closet-panel' && !initGuards.closet) {
          try {
            const mod = await import('/js/uploads/closet/closet-upload.js');
            if (tryInit(mod, ['setupClosetUploadUI', 'initClosetUpload', 'setupUploadUI']))
              initGuards.closet = true;
          } catch (err) { console.error('Closet UI init failed:', err); }
        }

        if (panel.id === 'voice-panel' && !initGuards.voice) {
          try {
            const mod = await import('/js/uploads/voice/voice-upload.js');
            if (tryInit(mod, ['setupVoiceUploadUI', 'initVoiceUpload', 'setupUploadUI']))
              initGuards.voice = true;
          } catch (err) { console.error('Voice UI init failed:', err); }
        }

        if (panel.id === 'episodes-panel' && !initGuards.episodes) {
          try {
            const mod = await import('/js/uploads/episodes/episode-upload.js');
            if (tryInit(mod, ['setupEpisodeUploadUI', 'initEpisodeUpload', 'setupUploadUI']))
              initGuards.episodes = true;
          } catch (err) { console.error('Episodes UI init failed:', err); }
        }
      } catch (err) {
        console.error(`Failed to load ${panel.id}:`, err);
      }
    }

    // Load all partials
    panels.forEach(loadPanel);

    // --- Smart-jump target for topbar links ---
    // topbar.js will call window.activateUploadPanel('closet' | 'voice' | 'episodes' | 'meta')
    const idMap = {
      closet:   'closet-panel',
      voice:    'voice-panel',
      episodes: 'episodes-panel',
      meta:     'meta-panel'
    };

    window.activateUploadPanel = async function(which) {
      const targetId = idMap[which] || which; // allow direct '#...-panel' too
      // Ensure panel element exists (partials might still be loading)
      const waitFor = async (id, tries = 20) => {
        for (let i = 0; i < tries; i++) {
          const el = document.getElementById(id);
          if (el) return el;
          await new Promise(r => setTimeout(r, 50));
        }
        return null;
      };

      const panelEl = await waitFor(targetId);
      if (!panelEl) {
        console.warn('[upload] panel not found for', which);
        return;
      }

      // Toggle visible panel
      document.querySelectorAll('.panel').forEach(p => p.classList.toggle('active', p.id === targetId));

      // Lazy init on jump (if user jumped before opening via any tab)
      try {
        if (targetId === 'voice-panel' && !initGuards.voice) {
          const mod = await import('/js/uploads/voice/voice-upload.js');
          if (tryInit(mod, ['setupVoiceUploadUI', 'initVoiceUpload', 'setupUploadUI']))
            initGuards.voice = true;
        }
        if (targetId === 'episodes-panel' && !initGuards.episodes) {
          const mod = await import('/js/uploads/episodes/episode-upload.js');
          if (tryInit(mod, ['setupEpisodeUploadUI', 'initEpisodeUpload', 'setupUploadUI']))
            initGuards.episodes = true;
        }
        if (targetId === 'closet-panel' && !initGuards.closet) {
          const mod = await import('/js/uploads/closet/closet-upload.js');
          if (tryInit(mod, ['setupClosetUploadUI', 'initClosetUpload', 'setupUploadUI']))
            initGuards.closet = true;
        }
      } catch (err) {
        console.error('Lazy init error on smart-jump:', err);
      }

      // Keep URL hash in sync (nice for reload/back)
      location.hash = `#${targetId}`;
    };

    // Open panel from hash on first load
    const initialHash = (location.hash || '').replace(/^#/, '');
    if (initialHash) {
      // Accept either panel-id or short key
      const which = idMap[initialHash] ? initialHash : Object.keys(idMap).find(k => idMap[k] === initialHash) ? initialHash : null;
      if (which) window.activateUploadPanel(which);
      else if (document.getElementById(initialHash)) window.activateUploadPanel(initialHash);
    }

    // Toast helper
    const toasts = document.getElementById('toasts');
    window.showToast = (msg) => {
      if (!toasts) return alert(msg);
      const node = document.createElement('div');
      node.className = 'toast';
      node.textContent = msg;
      toasts.appendChild(node);
      setTimeout(() => node.remove(), 3500);
    };
  </script>
</body>
</html>
